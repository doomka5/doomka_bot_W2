# Doomka W2 — веб-панель склада

Веб-интерфейс дублирует функциональность Telegram-бота Doomka W2 и работает с
той же базой данных PostgreSQL. Приложение построено на FastAPI, использует
шаблоны Jinja2 и готово к развёртыванию на QNAP через Docker Compose.

## Быстрый запуск через Docker

1. Убедитесь, что рядом находится `docker-compose.yml` из корня проекта. В нём
   уже описан сервис `fastapi_web` и контейнер PostgreSQL `postgres_bot`.
2. Запустите сервис (вместе с БД и ботом, если нужно):

   ```bash
   docker compose up -d fastapi_web
   ```

3. Панель будет доступна по адресу:

   ```
   http://<локальный_IP_устройства>:8181
   ```

   Контейнер слушает порт 8181, поэтому переадресация дополнительных портов не
   требуется.
4. Просмотр логов сервиса:

   ```bash
   docker logs -f fastapi_web
   ```

5. Для обновления после изменения кода выполните пересборку:

   ```bash
   docker compose up -d --build fastapi_web
   ```

## Маршруты веб-приложения

| Маршрут | Описание |
| --- | --- |
| `/` | Главная страница с кнопками навигации. |
| `/materials` | Таблица листовых материалов с фильтром `search` и сортировкой `sort`/`order`. |
| `/films` | Таблица плёнок с теми же параметрами фильтрации. |
| `/add` | Форма добавления новой записи в таблицы материалов или плёнок. |
| `/materials/export` | Экспорт видимых данных по материалам в Excel (`.xlsx`). |
| `/films/export` | Экспорт видимых данных по плёнкам в Excel. |
| `/materials/import` | Импорт данных листовых материалов из Excel. |
| `/films/import` | Импорт данных плёнок из Excel. |

Указанные страницы автоматически подхватывают реальные имена таблиц из базы
(`materials` либо `warehouse_plastics`, `films` либо `warehouse_films`).

## Подключение к базе данных

Параметры подключения читаются из переменных окружения (см. `docker-compose.yml`):

```bash
DB_HOST=postgres_bot
DB_PORT=5432
DB_NAME=botdb
DB_USER=botuser
DB_PASS=botpass
```

FastAPI создаёт пул соединений `asyncpg`, поэтому приложение корректно работает
в многопоточной среде и не блокирует обработку запросов.

## Примеры запросов

```bash
# Открыть список материалов с фильтром и сортировкой
curl "http://<локальный_IP_устройства>:8181/materials?search=АКПЛАСТ&sort=article&order=asc"

# Экспорт текущего набора данных по плёнкам в Excel
curl -o films.xlsx "http://<локальный_IP_устройства>:8181/films/export?search=белый"

# Загрузка Excel-файла с новыми листовыми материалами
curl -F "file=@materials.xlsx" http://<локальный_IP_устройства>:8181/materials/import
```

## Совместимость с Telegram-ботом

Бот и веб-панель используют единую схему PostgreSQL. Все изменения, внесённые в
интерфейсе, мгновенно доступны боту, и наоборот. Это гарантирует консистентность
данных независимо от того, каким способом пользователи обновляют склад.
